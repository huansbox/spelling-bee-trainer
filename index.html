<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spelling Bee å† è»è¨“ç·´å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #f3f4f6;
            user-select: none; /* é˜²æ­¢èª¤é¸æ–‡å­— */
        }
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .mode-transition {
            transition: all 0.3s ease;
        }
        /* è­·çœ¼å°ˆç”¨ï¼šæŸ”å’Œçš„å–®å­—é¡¯ç¤ºå€èƒŒæ™¯ */
        .eye-care-bg {
            background-color: #f8fafc; /* Slate-50 */
            border: 3px solid #e2e8f0; /* Slate-200 */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- é ‚éƒ¨å°èˆª -->
    <header class="bg-white shadow-sm p-4 sticky top-0 z-10">
        <div class="max-w-4xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-bee text-yellow-500"></i> Spelling Bee è¨“ç·´å™¨
            </h1>
            
            <div class="flex bg-gray-100 p-1 rounded-lg">
                <button onclick="switchMode('practice')" id="btn-mode-practice" class="px-6 py-2 rounded-md text-sm font-bold transition-all duration-200 flex items-center gap-2">
                    <i class="fas fa-book-open"></i> ç·´ç¿’æ¨¡å¼
                </button>
                <button onclick="switchMode('rehearsal')" id="btn-mode-rehearsal" class="px-6 py-2 rounded-md text-sm font-bold transition-all duration-200 flex items-center gap-2">
                    <i class="fas fa-microphone-alt"></i> é æ¼”æ¨¡å¼
                </button>
            </div>
        </div>
    </header>

    <!-- é€²åº¦æ¢å€åŸŸ -->
    <div class="bg-gray-200 h-4 w-full">
        <div id="progress-bar" class="h-full bg-green-500 transition-all duration-500" style="width: 0%"></div>
    </div>
    <div class="text-center text-xs text-gray-500 py-1">
        ç›®å‰é€²åº¦ï¼šç¬¬ <span id="current-batch-display">1</span> çµ„ / å…± 20 çµ„
    </div>

    <!-- ä¸»å…§å®¹å€åŸŸ -->
    <main class="flex-grow flex flex-col items-center justify-center p-4 max-w-4xl mx-auto w-full">
        
        <!-- ç·´ç¿’æ¨¡å¼ä»‹é¢ -->
        <div id="view-practice" class="w-full hidden">
            <div class="bg-white rounded-3xl p-8 card-shadow border-b-8 border-blue-200 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-4 bg-blue-400"></div>
                
                <!-- å–®å­—é¡¯ç¤ºå€ (å„ªåŒ–ç‰ˆ) -->
                <div class="mb-8">
                    <div class="w-full h-64 md:h-80 eye-care-bg rounded-3xl flex items-center justify-center mb-4 relative overflow-hidden px-2">
                        <!-- èƒŒæ™¯è£é£¾åœ“åœˆï¼Œå¢åŠ æŸ”å’Œæ„Ÿä½†ä¸æ˜é¡¯ -->
                        <div class="absolute w-96 h-96 bg-blue-50 rounded-full -top-20 -left-20 opacity-50"></div>
                        <div class="absolute w-64 h-64 bg-indigo-50 rounded-full -bottom-10 -right-10 opacity-50"></div>
                        
                        <!-- æ ¸å¿ƒå–®å­—ï¼šClass å°‡ç”± JS å‹•æ…‹æ§åˆ¶ä»¥é©æ‡‰é•·åº¦ -->
                        <h2 id="practice-word" class="relative z-10 font-bold text-gray-700 tracking-wide select-none transition-all duration-300">
                            word
                        </h2>
                    </div>
                    <p class="text-gray-400 text-sm font-medium">å–®å­—å¡ <span id="practice-counter">1/5</span></p>
                </div>

                <!-- æ’­æ”¾æ§åˆ¶ -->
                <button onclick="playCurrentWord()" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white text-2xl font-bold py-6 px-12 rounded-full shadow-lg transform active:scale-95 transition-transform mb-8 flex items-center justify-center gap-4 mx-auto">
                    <i class="fas fa-volume-up"></i> è½ç™¼éŸ³ (x2)
                </button>

                <!-- å°èˆª -->
                <div class="flex justify-between items-center mt-4">
                    <button id="btn-prev-practice" onclick="prevPracticeCard()" class="text-gray-400 hover:text-blue-500 p-4 text-xl transition-opacity">
                        <i class="fas fa-chevron-left"></i> ä¸Šä¸€å€‹
                    </button>
                    <div class="flex gap-2" id="practice-dots">
                        <!-- JSç”Ÿæˆåœ“é» -->
                    </div>
                    <button id="btn-next-practice" onclick="nextPracticeCard()" class="text-gray-400 hover:text-blue-500 p-4 text-xl transition-opacity">
                        ä¸‹ä¸€å€‹ <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- æ–°å¢ï¼šå®Œæˆæç¤ºæŒ‰éˆ• -->
            <div id="practice-finish-hint" class="hidden text-center mt-6 animate-bounce">
                <button onclick="switchMode('rehearsal')" class="bg-orange-100 text-orange-600 px-6 py-3 rounded-full font-bold shadow-sm hover:bg-orange-200 transition-colors border-2 border-orange-200">
                   é€™ 5 å€‹å­—ç†Ÿäº†å—ï¼Ÿé–‹å§‹é æ¼”æ¸¬è©¦ï¼ <i class="fas fa-trophy ml-1"></i>
                </button>
            </div>

            <p class="text-center text-gray-500 mt-4 text-sm">ğŸ’¡ æç¤ºï¼šå…ˆè½ç†Ÿè²éŸ³ï¼Œçœ‹ç†Ÿæ‹¼å­—ï¼Œå†é€²å…¥é æ¼”æ¨¡å¼ã€‚</p>
        </div>

        <!-- é æ¼”æ¨¡å¼ä»‹é¢ -->
        <div id="view-rehearsal" class="w-full hidden">
            
            <!-- éšæ®µ 1: è€å¸«å‡ºé¡Œ -->
            <div id="rehearsal-step-question" class="bg-white rounded-3xl p-8 card-shadow border-b-8 border-orange-200 text-center relative w-full max-w-2xl mx-auto">
                <div class="absolute top-0 left-0 w-full h-4 bg-orange-400"></div>
                <div class="absolute top-4 left-4 bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-xs font-bold">å®¶é•·æ“ä½œ</div>

                <h3 class="text-xl text-gray-500 mb-8 mt-4">è«‹å®¶é•·æŒ‰ä¸‹æŒ‰éˆ•å‡ºé¡Œ</h3>
                
                <div class="bg-gray-50 p-6 rounded-xl mb-8 border-2 border-dashed border-gray-200">
                    <p class="text-sm text-gray-400 mb-2">ç›®å‰å–®å­— (åƒ…å®¶é•·å¯è¦‹)</p>
                    <p id="rehearsal-hidden-word" class="text-3xl font-bold text-gray-800 blur-sm hover:blur-none cursor-pointer transition-all">hover to see</p>
                </div>

                <button onclick="playTeacherAudio()" class="w-full bg-orange-500 hover:bg-orange-600 text-white text-3xl font-bold py-8 px-8 rounded-2xl shadow-lg transform active:scale-95 transition-transform flex items-col justify-center gap-3 mb-6">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-podcast text-4xl mb-2"></i>
                        <span>æ’­æ”¾è€å¸«å‡ºé¡Œ</span>
                    </div>
                </button>
                
                <p class="text-gray-500 mb-6">å°å­©å›ç­”å®Œç•¢å¾Œ...</p>
                <button onclick="showAnswer()" class="text-orange-500 font-bold text-lg border-2 border-orange-500 px-8 py-3 rounded-full hover:bg-orange-50 transition-colors">
                    é¡¯ç¤ºç­”æ¡ˆèˆ‡è©•åˆ†
                </button>
            </div>

            <!-- éšæ®µ 2: ç­”æ¡ˆèˆ‡è©•åˆ† -->
            <div id="rehearsal-step-answer" class="hidden bg-white rounded-3xl p-8 card-shadow border-b-8 border-green-200 text-center relative w-full max-w-2xl mx-auto">
                <div class="absolute top-0 left-0 w-full h-4 bg-green-400"></div>
                
                <h3 class="text-gray-400 text-sm mb-2">æ¨™æº–ç­”æ¡ˆæ ¼å¼</h3>
                
                <!-- ç­”æ¡ˆé¡¯ç¤ºå€ -->
                <div class="bg-green-50 p-6 rounded-xl mb-6">
                    <div id="answer-display" class="text-3xl md:text-4xl font-bold text-gray-800 font-mono">
                        <!-- JS å¡«å…¥: ace, a-c-e, ace -->
                    </div>
                </div>

                <button onclick="playCorrectSpelling()" class="mb-8 text-green-600 bg-green-100 hover:bg-green-200 px-4 py-2 rounded-lg text-sm font-bold">
                    <i class="fas fa-volume-up"></i> è½æ­£ç¢ºæ‹¼è®€
                </button>

                <h3 class="text-xl font-bold text-gray-700 mb-4">å°å­©è¡¨ç¾å¦‚ä½•ï¼Ÿ</h3>
                <div class="grid grid-cols-3 gap-4">
                    <button onclick="rateWord('retry')" class="bg-red-100 hover:bg-red-200 text-red-600 py-4 rounded-xl font-bold flex flex-col items-center gap-2 border-b-4 border-red-300 active:border-b-0 active:translate-y-1">
                        <i class="fas fa-times-circle text-2xl"></i>
                        ä¸ç†Ÿ
                        <span class="text-xs font-normal text-red-400">ç¨å¾Œé‡è€ƒ</span>
                    </button>
                    <button onclick="rateWord('hard')" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-600 py-4 rounded-xl font-bold flex flex-col items-center gap-2 border-b-4 border-yellow-300 active:border-b-0 active:translate-y-1">
                        <i class="fas fa-exclamation-circle text-2xl"></i>
                        é‚„å¯ä»¥
                        <span class="text-xs font-normal text-yellow-500">ä¿ç•™åœ¨éšŠåˆ—</span>
                    </button>
                    <button onclick="rateWord('ok')" class="bg-green-100 hover:bg-green-200 text-green-600 py-4 rounded-xl font-bold flex flex-col items-center gap-2 border-b-4 border-green-300 active:border-b-0 active:translate-y-1">
                        <i class="fas fa-check-circle text-2xl"></i>
                        OK!
                        <span class="text-xs font-normal text-green-500">å®Œæˆ</span>
                    </button>
                </div>
            </div>

            <!-- éšæ®µ 3: æœ¬çµ„å®Œæˆ -->
            <div id="rehearsal-step-complete" class="hidden text-center py-12">
                <div class="text-6xl mb-6">ğŸ†</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">æ­å–œï¼é€™çµ„å–®å­—éƒ½ç†Ÿäº†ï¼</h2>
                <p class="text-gray-600 mb-8">ä½ çš„è¡¨ç¾éå¸¸æ£’ï¼Œæº–å‚™å¥½æŒ‘æˆ°ä¸‹ä¸€çµ„äº†å—ï¼Ÿ</p>
                <button onclick="unlockNextBatch()" class="bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white text-2xl font-bold py-4 px-12 rounded-full shadow-xl transform hover:scale-105 transition-all animate-bounce">
                    è§£é–ä¸‹ä¸€çµ„ (Next 5) <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
            
            <!-- ç‹€æ…‹æç¤º -->
            <div class="mt-6 text-center">
                <span class="inline-block bg-gray-200 rounded-full px-3 py-1 text-xs font-bold text-gray-500">
                    å‰©é¤˜éœ€è¤‡ç¿’ï¼š<span id="queue-count">0</span> å€‹å–®å­—
                </span>
            </div>
        </div>

    </main>

    <!-- é å°¾é‡ç½®èˆ‡åŒ¯å‡ºå…¥åŠŸèƒ½ -->
    <footer class="py-8 bg-gray-100 border-t border-gray-200 mt-auto">
        <div class="max-w-4xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
            
            <div class="text-sm text-gray-500">
                é€²åº¦ç®¡ç† (Data Management)
            </div>

            <div class="flex gap-4">
                <button onclick="exportProgress()" class="bg-white border border-gray-300 text-gray-600 hover:text-blue-600 hover:border-blue-400 px-4 py-2 rounded-md text-sm transition-colors flex items-center gap-2">
                    <i class="fas fa-file-export"></i> åŒ¯å‡ºé€²åº¦ (Export)
                </button>
                
                <button onclick="importProgress()" class="bg-white border border-gray-300 text-gray-600 hover:text-blue-600 hover:border-blue-400 px-4 py-2 rounded-md text-sm transition-colors flex items-center gap-2">
                    <i class="fas fa-file-import"></i> åŒ¯å…¥é€²åº¦ (Import)
                </button>
            </div>

            <button onclick="resetProgress()" class="text-gray-400 text-xs hover:text-red-500 transition-colors border-b border-transparent hover:border-red-500 pb-1 mt-2 md:mt-0">
                <i class="fas fa-trash-alt mr-1"></i> é‡ç½® (Reset)
            </button>
        </div>
    </footer>

    <script>
        // --- 1. Data Source ---
        const fullWordList = [
            // Part 1
            "ace", "actor", "almond", "alphabet", "amount",
            "arrow", "article", "badger", "barber", "basic",
            "battle", "beginner", "bind", "borrow", "bother",
            "cactus", "cartoon", "center", "checkers", "chimney",
            "claim", "clerk", "click", "cliff", "clue",
            // Part 2
            "cocoon", "control", "corner", "cue", "daydream",
            "disk", "drill", "dust", "enemy", "equal",
            "erase", "example", "field", "firefly", "fireworks",
            "firm", "flash", "flight", "fresh", "giant",
            "grand", "harbor", "haunt", "history", "hungry",
            // Part 3
            "iron", "island", "jellyfish", "knight", "know-how",
            "ladybird", "lighthouse", "lonely", "maple", "meter",
            "middle", "mole", "narrow", "offer", "onion",
            "period", "plain", "powerful", "pretend", "pride",
            "recess", "record", "result", "rude", "season",
            // Part 4
            "settle", "share", "speech", "steak", "steel",
            "Stone Age", "strawberry", "success", "sundown", "sunlit",
            "sunrise", "supper", "telephone", "thirsty", "thread",
            "toilet", "total", "trash", "value", "vote",
            "wasp", "wildcat", "willow", "yourself", "youth"
        ];

        // --- 2. State Management ---
        const BATCH_SIZE = 5;
        const STORAGE_KEY = 'spelling_bee_progress_v1';

        let state = {
            currentBatchIndex: 0, // 0 to 19
            mode: 'practice', // 'practice' or 'rehearsal'
            
            // Practice Mode State
            practiceCardIndex: 0, // 0 to 4 within current batch

            // Rehearsal Mode State
            rehearsalQueue: [], // Array of objects: { word: "ace", status: "pending" }
            currentRehearsalWord: null,
        };

        // --- 3. Initialization & Storage ---
        function init() {
            if (!loadProgress()) {
                loadBatch(0);
            }
            render();

            // If loading into rehearsal mode, ensure UI state is correct
            if (state.mode === 'rehearsal') {
                 // Check if batch is complete
                 if (state.rehearsalQueue.every(i => i.status === 'ok')) {
                     showRehearsalComplete();
                 } else {
                     // Pick a word if needed
                     if (!state.currentRehearsalWord) {
                         pickNextRehearsalWord();
                     }
                     // Ensure correct view is shown (Question vs Answer)
                     // Default to Question step when resuming
                     document.getElementById('rehearsal-step-question').classList.remove('hidden');
                     document.getElementById('rehearsal-step-answer').classList.add('hidden');
                     document.getElementById('rehearsal-step-complete').classList.add('hidden');
                 }
            }
        }

        function saveProgress() {
            const dataToSave = {
                currentBatchIndex: state.currentBatchIndex,
                rehearsalQueue: state.rehearsalQueue,
                mode: state.mode
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
        }

        function loadProgress() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) return false;

            try {
                const parsed = JSON.parse(savedData);
                
                // Basic validation
                if (typeof parsed.currentBatchIndex !== 'number') return false;

                state.currentBatchIndex = parsed.currentBatchIndex;
                state.mode = parsed.mode || 'practice';
                
                // Restore Queue
                if (Array.isArray(parsed.rehearsalQueue) && parsed.rehearsalQueue.length > 0) {
                    state.rehearsalQueue = parsed.rehearsalQueue;
                } else {
                    // Fallback: reload queue from list
                    const start = state.currentBatchIndex * BATCH_SIZE;
                    const end = start + BATCH_SIZE;
                    state.rehearsalQueue = fullWordList.slice(start, end).map(w => ({ word: w, status: 'pending' }));
                }

                return true;
            } catch (e) {
                console.error("Failed to load progress", e);
                return false;
            }
        }

        function resetProgress() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰é€²åº¦å—ï¼Ÿé€™å°‡æœƒæ¸…é™¤æ‰€æœ‰çš„å­¸ç¿’ç´€éŒ„ï¼Œå›åˆ°ç¬¬ä¸€å€‹å–®å­—ã€‚')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // --- Export / Import Logic ---
        function exportProgress() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (!data) {
                alert("ç›®å‰æ²’æœ‰é€²åº¦å¯åŒ¯å‡ºã€‚");
                return;
            }
            // Encode to Base64 to allow easy copy-pasting without formatting issues
            // Using encodeURIComponent to handle any potential unicode characters safely
            const token = btoa(encodeURIComponent(data));
            
            // Try to copy to clipboard automatically
            navigator.clipboard.writeText(token).then(() => {
                alert("âœ… é€²åº¦ä»£ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n\nè«‹åœ¨å¦ä¸€å°è£ç½®é»é¸ã€ŒåŒ¯å…¥é€²åº¦ã€ä¸¦è²¼ä¸Šæ­¤ä»£ç¢¼ã€‚");
            }).catch(err => {
                // Fallback if auto-copy fails
                prompt("è«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹ä»£ç¢¼ï¼š", token);
            });
        }

        function importProgress() {
            const token = prompt("è«‹è²¼ä¸Šé€²åº¦ä»£ç¢¼ï¼š");
            if (!token) return;
            
            try {
                const jsonStr = decodeURIComponent(atob(token));
                const data = JSON.parse(jsonStr);
                
                // Simple validation
                if (typeof data.currentBatchIndex !== 'number') throw new Error("Invalid data");
                
                localStorage.setItem(STORAGE_KEY, jsonStr);
                alert("âœ… åŒ¯å…¥æˆåŠŸï¼ç¶²é å°‡é‡æ–°æ•´ç†ä»¥è¼‰å…¥æ–°é€²åº¦ã€‚");
                location.reload();
            } catch (e) {
                alert("âŒ ä»£ç¢¼æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•åŒ¯å…¥ã€‚\nè«‹ç¢ºèªä»£ç¢¼æ˜¯å¦å®Œæ•´è¤‡è£½ã€‚");
            }
        }

        function loadBatch(batchIndex) {
            state.currentBatchIndex = batchIndex;
            state.practiceCardIndex = 0;
            
            // Get words for this batch
            const start = batchIndex * BATCH_SIZE;
            const end = start + BATCH_SIZE;
            const batchWords = fullWordList.slice(start, end);

            // Initialize Queue for Rehearsal
            // Strict order maintained (ace -> actor -> almond...) as per rules
            state.rehearsalQueue = batchWords.map(w => ({ word: w, status: 'pending' }));
            
            saveProgress(); // Save initial batch state
        }

        // --- 4. Core Logic: TTS ---
        const synth = window.speechSynthesis;

        function speakText(text, rate = 0.9) {
            if (synth.speaking) synth.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'en-US';
            utter.rate = rate;
            synth.speak(utter);
        }

        function playCurrentWord() {
            const word = getCurrentPracticeWord();
            // Pattern: Word ... (1s) ... Word
            speakText(word);
            setTimeout(() => {
                speakText(word);
            }, 1500);
        }

        function playTeacherAudio() {
            if (!state.currentRehearsalWord) pickNextRehearsalWord();
            const word = state.currentRehearsalWord.word;
            
            speakText(word);
            setTimeout(() => {
                speakText(word);
            }, 1500);
        }

        function playCorrectSpelling() {
            const word = state.currentRehearsalWord.word;
            speakText(word);
        }

        // --- 5. Practice Mode Logic ---
        function getCurrentPracticeWord() {
            const start = state.currentBatchIndex * BATCH_SIZE;
            return fullWordList[start + state.practiceCardIndex];
        }

        function nextPracticeCard() {
            if (state.practiceCardIndex < BATCH_SIZE - 1) {
                state.practiceCardIndex++;
                render();
            }
        }

        function prevPracticeCard() {
            if (state.practiceCardIndex > 0) {
                state.practiceCardIndex--;
                render();
            }
        }

        // --- 6. Rehearsal Mode Logic ---
        function pickNextRehearsalWord() {
            // Find words that are NOT ok
            const pending = state.rehearsalQueue.filter(item => item.status !== 'ok');
            
            if (pending.length === 0) {
                state.currentRehearsalWord = null;
                showRehearsalComplete();
                return;
            }

            // Pick the first one (list is already shuffled initially, and re-pushed on retry)
            state.currentRehearsalWord = pending[0];
            
            // Update UI to Question Step
            document.getElementById('rehearsal-step-question').classList.remove('hidden');
            document.getElementById('rehearsal-step-answer').classList.add('hidden');
            document.getElementById('rehearsal-step-complete').classList.add('hidden');
            
            // Reset Word display (blurred)
            const hiddenWordEl = document.getElementById('rehearsal-hidden-word');
            hiddenWordEl.innerText = state.currentRehearsalWord.word;
            hiddenWordEl.classList.add('blur-sm');
        }

        function showAnswer() {
            document.getElementById('rehearsal-step-question').classList.add('hidden');
            document.getElementById('rehearsal-step-answer').classList.remove('hidden');
            
            // Format answer string: "word, w-o-r-d, word"
            const word = state.currentRehearsalWord.word;
            const letters = word.split('').join('-');
            const displayString = `${word}, ${letters}, ${word}`;
            document.getElementById('answer-display').innerText = displayString;
        }

        function rateWord(rating) {
            // rating: 'retry' (red), 'hard' (yellow), 'ok' (green)
            
            // Update status in queue
            const currentItem = state.rehearsalQueue.find(i => i.word === state.currentRehearsalWord.word);
            
            if (rating === 'ok') {
                currentItem.status = 'ok';
            } else if (rating === 'retry') {
                currentItem.status = 'retry';
                // Move to end of queue to ask again later
                state.rehearsalQueue = state.rehearsalQueue.filter(i => i !== currentItem);
                state.rehearsalQueue.push(currentItem);
            } else if (rating === 'hard') {
                currentItem.status = 'hard';
                // Move to end as well
                state.rehearsalQueue = state.rehearsalQueue.filter(i => i !== currentItem);
                state.rehearsalQueue.push(currentItem);
            }

            saveProgress(); // SAVE PROGRESS ON RATING
            pickNextRehearsalWord(); // Go to next
            renderRehearsalStats(); // Update counters
        }

        function showRehearsalComplete() {
            document.getElementById('rehearsal-step-question').classList.add('hidden');
            document.getElementById('rehearsal-step-answer').classList.add('hidden');
            document.getElementById('rehearsal-step-complete').classList.remove('hidden');
        }

        function unlockNextBatch() {
            if (state.currentBatchIndex < (fullWordList.length / BATCH_SIZE) - 1) {
                loadBatch(state.currentBatchIndex + 1);
                // Switch back to practice mode for new words
                switchMode('practice');
                render();
                // Show toast or alert?
            } else {
                alert("æ­å–œï¼ä½ å·²ç¶“å®Œæˆäº†æ‰€æœ‰çš„å–®å­—è¡¨ï¼å¤ªå²å®³äº†ï¼");
            }
        }

        // --- 7. UI Helper: Font Size Scaling ---
        function adjustFontSize(word) {
            const el = document.getElementById('practice-word');
            // Reset base classes
            el.className = "relative z-10 font-bold text-gray-700 tracking-wide select-none transition-all duration-300";
            
            const len = word.length;
            if (len <= 5) {
                // çŸ­å–®å­— (ace)ï¼šç¶­æŒå·¨å¤§ (Mobile: 7xl, Desktop: 9xl)
                el.classList.add('text-7xl', 'md:text-9xl');
            } else if (len <= 8) {
                // ä¸­å–®å­— (alphabet)ï¼šMobile ç¸®å°è‡³ 5xl, Desktop ç¶­æŒå¤§å­— 8xl
                el.classList.add('text-5xl', 'md:text-8xl');
            } else {
                // é•·å–®å­— (strawberry)ï¼šMobile ç¸®å°è‡³ 4xl, Desktop 7xl
                el.classList.add('text-4xl', 'md:text-7xl');
            }
        }

        // --- 8. Rendering & UI Switching ---
        function switchMode(mode) {
            state.mode = mode;
            saveProgress(); // SAVE MODE PREFERENCE
            render();
            
            // If switching to rehearsal, ensure a word is picked
            if (mode === 'rehearsal') {
                // Reset view state
                if (state.rehearsalQueue.every(i => i.status === 'ok')) {
                     showRehearsalComplete();
                } else {
                    // If we are in the middle of a word, keep it, otherwise pick
                    if (!state.currentRehearsalWord || state.currentRehearsalWord.status === 'ok') {
                        pickNextRehearsalWord();
                    } else {
                        // Restore current view (question)
                         document.getElementById('rehearsal-step-question').classList.remove('hidden');
                         document.getElementById('rehearsal-step-answer').classList.add('hidden');
                         document.getElementById('rehearsal-step-complete').classList.add('hidden');
                    }
                }
            }
        }

        function render() {
            // 1. Header Buttons
            const btnPractice = document.getElementById('btn-mode-practice');
            const btnRehearsal = document.getElementById('btn-mode-rehearsal');
            
            if (state.mode === 'practice') {
                btnPractice.className = "px-6 py-2 rounded-md text-sm font-bold transition-all duration-200 flex items-center gap-2 bg-blue-500 text-white shadow-lg transform scale-105";
                btnRehearsal.className = "px-6 py-2 rounded-md text-sm font-bold transition-all duration-200 flex items-center gap-2 text-gray-500 hover:bg-gray-200";
                document.getElementById('view-practice').classList.remove('hidden');
                document.getElementById('view-rehearsal').classList.add('hidden');
                renderPractice();
            } else {
                btnPractice.className = "px-6 py-2 rounded-md text-sm font-bold transition-all duration-200 flex items-center gap-2 text-gray-500 hover:bg-gray-200";
                btnRehearsal.className = "px-6 py-2 rounded-md text-sm font-bold transition-all duration-200 flex items-center gap-2 bg-orange-500 text-white shadow-lg transform scale-105";
                document.getElementById('view-practice').classList.add('hidden');
                document.getElementById('view-rehearsal').classList.remove('hidden');
                renderRehearsalStats();
            }

            // 2. Progress Bar
            const totalBatches = fullWordList.length / BATCH_SIZE;
            const progress = ((state.currentBatchIndex) / totalBatches) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('current-batch-display').innerText = state.currentBatchIndex + 1;
        }

        function renderPractice() {
            const word = getCurrentPracticeWord();
            document.getElementById('practice-word').innerText = word;
            
            // Dynamic Font Size Adjustment
            adjustFontSize(word);

            document.getElementById('practice-counter').innerText = `${state.practiceCardIndex + 1}/${BATCH_SIZE}`;
            
            // Dots
            const dotsContainer = document.getElementById('practice-dots');
            dotsContainer.innerHTML = '';
            for(let i=0; i<BATCH_SIZE; i++) {
                const dot = document.createElement('div');
                dot.className = `w-3 h-3 rounded-full ${i === state.practiceCardIndex ? 'bg-blue-500' : 'bg-gray-300'}`;
                dotsContainer.appendChild(dot);
            }

            // Button States & Hint
            const btnPrev = document.getElementById('btn-prev-practice');
            const btnNext = document.getElementById('btn-next-practice');
            const hintDiv = document.getElementById('practice-finish-hint');

            // Prev button logic
            if (state.practiceCardIndex === 0) {
                btnPrev.style.opacity = '0.3';
                btnPrev.style.cursor = 'not-allowed';
            } else {
                btnPrev.style.opacity = '1';
                btnPrev.style.cursor = 'pointer';
            }

            // Next button logic & Hint
            if (state.practiceCardIndex === BATCH_SIZE - 1) {
                btnNext.style.opacity = '0.3';
                btnNext.style.cursor = 'not-allowed';
                hintDiv.classList.remove('hidden'); // Show the call-to-action
            } else {
                btnNext.style.opacity = '1';
                btnNext.style.cursor = 'pointer';
                hintDiv.classList.add('hidden');
            }
        }

        function renderRehearsalStats() {
            const remaining = state.rehearsalQueue.filter(i => i.status !== 'ok').length;
            document.getElementById('queue-count').innerText = remaining;
        }

        // Start
        init();

    </script>
</body>
</html>